---
layout: post
title: Animbus代码分析
tags: flask web
category: it
---

{% raw %}



##/cloud/instances/
接下来我们从页面角度分析，先看`/cloud/instances/`页面，处理函数是`views.py`中的`index()`：

* `portal/cloud/instances/views.py`

        @expose('/')
        def index(self):

            self.columns = [_("Instance Name"), _("IP Address"), _("Size"),
                            _("Keypair"), _("Status"), _("Task"),
                            _("Power State"), _("Action")]
                            
            # Actions
            actions, actions_confirmation = self.get_actions_list()
    
            # For Get Request
            request = {'action':'list_instance', 'body':'{}'}
            dispatcher = Dispatcher(request)
            resp_id = dispatcher.sendRequest()['requestId']
    
            return self.render(self.index_template,
                               resp_id = resp_id,
                               columns=self.columns,
                               actions=actions,
                               actions_confirmation=actions_confirmation)

    把参数打印出来看看：

        actions: [('launch', u'Launch Instance', 'btn', 'icon-plus', True), ('terminate', u'Terminate Instance', 'btn btn-primary', 'icon-trash icon-white', False)]
        actions_confirmation: {}
        resp_id: 20131221221124e99cd871e76d4355ab44fbd7f948d0d

    `actions`的结构可以参考`get_actions_list()`的返回值：`(name, text, class, icon_class, ajax_modal)`  
    `actions_confirmation`是弹框确认信息，目前为空  
    `resp_id`看不懂，先不管  
    `index_template = 'cloud/instances/index.html'`在`base.py`中定义

* `cloud/instances/index.html`

        # 省略无关代码
        {% extends 'cloud/instances/layout.html' %}
        {% import 'flask_admin/tables.html' as tableslib with context %}

        {% block extra_javascript %}
            <script type="text/javascript" src="{{ url_for('.static', filename='js/jquery.dataTables.min.js') }}"></script>
            <script type="text/javascript" src="{{ url_for('.static', filename='js/userportal/getresponse.js') }}"></script>
        {% endblock %}

        {% block content %}
            {{ tableslib.render_table() }}
        {% endblock %}

    `cloud/instances/layout.html`里面就是一些title文本：

        {% extends 'cloud/layout.html' %}
        {% block pageicon %}iconfa-table{% endblock %}
        {% block smalltitle %} Virtual Machines {% endblock %}
        {% block bigtitle %} Instances Overview{% endblock %}

    模板继承关系如下：

        cloud/instances/index.html
        cloud/instances/layout.html
        cloud/layout.html
        base.html

    表格显示代码在`flask_admin/tables.html`里面：

        # 省略无关代码
        {% macro render_table() %}
            <table id="dyntable" class="dataTable table table-bordered responsive" data-resqid="{{ resp_id }}">
              <tbody>
              </tbody>
            </table>
        {% endmacro %}


    只有一个空的`table`，数据由`js/userportal/getresponse.js`填充（因此目前是死数据）：

        jQuery(document).ready(function(){
          function fnClickAddRow() {
            jQuery('#dyntable').dataTable().fnAddData([
            [
                '<span class="center"><div id="uniform-undefined" class="checker"><span><input type="checkbox" /></span></div></span>',
                "Ubuntu 12.04",
                "10.196.5.7",
                "m1.tiny | 512MB RAM | 2 VCPUs | 0 Disk",
                "key01",
                "Active",
                "None",
                "Running",
                '<div class="btn-group "><button class="btn">Create Snapshot</button><button data-toggle="dropdown" class="btn btn-info dropdown-toggle">Action <span class="caret"></span></button><ul class="dropdown-menu"><li><a href="#">Associate Floting IP</a></li><li><a href="#">Disassociate Floting IP</a></li><li><a href="#">Edit Instance</a></li><li><a href="#">Edit Security Groups</a></li><li><a href="#">Console</a></li><li><a href="#">Boot Log</a></li><li><a href="#">Reboot</a></li><li><a href="#">Shutdown</a></li><li class="divider"></li><li><a href="#">Terminate</a></li></ul></div>' ],
            ]);
          }
        });

    表格处理使用`dataTables`插件，具体用法请参考相关文档，简单来说就是将要显示的数据全部传进去，然后由它负责显示清单以及翻页处理等等；  
    按钮` Launch Instance`和` Terminate Instance`的显示方法请参考`Flask-Admin`的`ActionsMixin`模块；


{% endraw %}

